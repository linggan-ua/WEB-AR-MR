<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>岭南乐器WebXR增强现实视听工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    
    <!-- 动态加载GLTFLoader -->
    <script>
        // 动态加载GLTFLoader
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js';
            script.onload = function() {
                console.log('GLTFLoader加载成功');
                window.gltfLoaderReady = true;
                if (window.app) {
                    window.app.initializeLoader();
                }
            };
            script.onerror = function() {
                console.error('GLTFLoader加载失败，尝试备用方案...');
                // 尝试其他CDN
                const backupScript = document.createElement('script');
                backupScript.src = 'https://threejs.org/examples/js/loaders/GLTFLoader.js';
                backupScript.onload = function() {
                    console.log('GLTFLoader备用源加载成功');
                    window.gltfLoaderReady = true;
                    if (window.app) {
                        window.app.initializeLoader();
                    }
                };
                backupScript.onerror = function() {
                    console.error('所有GLTFLoader源都加载失败');
                    window.gltfLoaderReady = false;
                };
                document.head.appendChild(backupScript);
            };
            document.head.appendChild(script);
        })();
    </script>

    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #startContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }
        
        #startWebXR {
            padding: 20px 40px;
            font-size: 18px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }
        
        #fallbackAR {
            padding: 15px 30px;
            font-size: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10;
            display: none;
        }
        
        #audioControls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            display: none;
        }
        
        #playButton {
            padding: 10px 20px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #playButton:disabled {
            background: grey;
            cursor: not-allowed;
        }
        
        #debugInfo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        #qrCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <div id="startContainer">
        <h2>岭南乐器WebXR体验</h2>
        <p>请选择体验模式：</p>
        <button id="startWebXR">启动WebXR模式</button>
        <br>
        <button id="fallbackAR">测试模式</button>
        <p><small>WebXR模式需要VR头显支持</small></p>
    </div>
    
    <div id="info">
        <div>状态: <span id="status">准备就绪</span></div>
        <div>检测到的码: <span id="qrResult">无</span></div>
        <div>当前乐器: <span id="currentInstrument">无</span></div>
        <div id="instructionText">请将二维码置于视野中心</div>
    </div>
    
    <div id="audioControls">
        <button id="playButton" disabled>播放</button>
        <span id="audioInfo">无音频</span>
    </div>
    
    <div id="debugInfo">
        <div>调试信息:</div>
        <div id="debugText"></div>
    </div>
    
    <canvas id="qrCanvas"></canvas>

    <script>
        // 全局变量
        let app = null;
        
        // 主应用类
        class WebXRARInstrument {
            constructor() {
                console.log('开始初始化WebXRARInstrument...');
                
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.xrSession = null;
                this.referenceSpace = null;
                this.controllers = [];
                this.currentInstrument = null;
                this.isWebXRMode = false;
                this.modelLoader = null;
                
                // 乐器配置 - 与传统版本保持一致
                this.instrumentConfigs = {
                    'pattern1': {
                        model: 'model1.gltf',
                        audio: 'audio1.mp3',
                        info: 'info1.txt',
                        scale: [0.02, 0.02, 0.02],  // 原始缩放
                        name: '乐器1'
                    },
                    'pattern2': {
                        model: 'model2.gltf', 
                        audio: 'audio2.mp3',
                        info: 'info2.txt',
                        scale: [0.03, 0.03, 0.03],  // 原始缩放
                        name: '乐器2'
                    }
                };
                
                this.loadedModels = new Map();
                this.activeModel = null;
                
                // 初始化各个模块
                this.audioManager = new AudioManager();
                this.qrDetector = new QRDetector();
                
                this.init();
            }
            
            async init() {
                try {
                    console.log('初始化UI...');
                    this.setupUI();
                    
                    console.log('初始化Three.js...');
                    this.setupThreeJS();
                    
                    console.log('初始化GLTFLoader...');
                    this.initializeLoader();
                    
                    console.log('预加载音频...');
                    await this.audioManager.preloadAudio(this.instrumentConfigs);
                    
                    console.log('初始化二维码检测器...');
                    this.qrDetector.init();
                    
                    console.log('WebXRARInstrument初始化完成');
                    this.updateDebugInfo('初始化完成');
                    
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.updateDebugInfo('初始化失败: ' + error.message);
                }
            }
            
            initializeLoader() {
                if (window.gltfLoaderReady && typeof THREE.GLTFLoader === 'function') {
                    try {
                        this.modelLoader = new THREE.GLTFLoader();
                        console.log('GLTFLoader初始化成功，现在可以加载真实的GLTF模型了');
                        this.updateDebugInfo('GLTFLoader: 已就绪');
                    } catch (error) {
                        console.error('GLTFLoader初始化失败:', error);
                        this.updateDebugInfo('GLTFLoader: 初始化错误');
                    }
                } else {
                    console.log('等待GLTFLoader加载...');
                    this.updateDebugInfo('GLTFLoader: 加载中...');
                    // 如果GLTFLoader还没有加载完成，稍后再试
                    setTimeout(() => {
                        this.initializeLoader();
                    }, 500);
                }
            }
            
            setupUI() {
                const startWebXR = document.getElementById('startWebXR');
                const fallbackAR = document.getElementById('fallbackAR');
                const playButton = document.getElementById('playButton');
                
                startWebXR.addEventListener('click', () => {
                    console.log('启动WebXR按钮被点击');
                    this.updateDebugInfo('尝试启动WebXR...');
                    this.startWebXR();
                });
                
                fallbackAR.addEventListener('click', () => {
                    console.log('测试模式按钮被点击');
                    this.updateDebugInfo('启动测试模式...');
                    this.startTestMode();
                });
                
                playButton.addEventListener('click', () => {
                    console.log('播放按钮被点击');
                    this.toggleAudio();
                });
                
                console.log('UI事件监听器已设置');
            }
            
            setupThreeJS() {
                // 创建场景
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x202020); // 深灰色背景，不是纯黑
                
                // 创建相机
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 1.6, 3); // 稍微远一点观察
                
                // 创建渲染器
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(this.renderer.domElement);
                
                // 添加灯光
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
                
                // 添加地面网格作为参考
                const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x444444);
                gridHelper.position.y = -1;
                this.scene.add(gridHelper);
                
                // 添加一个参考立方体确保场景可见
                const testGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const testMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x00ff00,
                    transparent: true,
                    opacity: 0.5
                });
                this.testCube = new THREE.Mesh(testGeometry, testMaterial);
                this.testCube.position.set(2, 0, -1);
                this.scene.add(this.testCube);
                
                // 设置渲染循环
                this.renderer.setAnimationLoop(() => this.render());
                
                // 窗口大小调整处理
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                console.log('Three.js设置完成');
            }
            
            async startWebXR() {
                if (!navigator.xr) {
                    console.log('WebXR不受支持');
                    alert('此设备不支持WebXR，请尝试测试模式');
                    this.updateDebugInfo('WebXR: 不支持');
                    return;
                }
                
                try {
                    console.log('检查WebXR支持...');
                    const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                    const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    
                    console.log('VR支持:', vrSupported, 'AR支持:', arSupported);
                    this.updateDebugInfo(`VR:${vrSupported} AR:${arSupported}`);
                    
                    if (!vrSupported && !arSupported) {
                        alert('此设备不支持WebXR，请尝试测试模式');
                        return;
                    }
                    
                    this.updateStatus('启动WebXR...');
                    
                    // 请求WebXR会话
                    const sessionMode = vrSupported ? 'immersive-vr' : 'immersive-ar';
                    console.log('请求会话模式:', sessionMode);
                    
                    this.xrSession = await navigator.xr.requestSession(sessionMode, {
                        requiredFeatures: ['local'],
                        optionalFeatures: ['bounded-floor', 'hand-tracking']
                    });
                    
                    console.log('WebXR会话创建成功');
                    await this.renderer.xr.setSession(this.xrSession);
                    this.referenceSpace = await this.xrSession.requestReferenceSpace('local');
                    
                    // 设置控制器
                    this.setupControllers();
                    
                    this.isWebXRMode = true;
                    this.hideStartContainer();
                    this.showControls();
                    this.updateStatus('WebXR运行中');
                    this.updateDebugInfo('WebXR会话活跃');
                    
                    // 添加测试乐器按钮
                    this.addTestButtons();
                    
                } catch (error) {
                    console.error('WebXR启动失败:', error);
                    this.updateStatus('启动失败: ' + error.message);
                    this.updateDebugInfo('WebXR错误: ' + error.message);
                    alert('WebXR启动失败: ' + error.message);
                }
            }
            
            startTestMode() {
                console.log('启动测试模式...');
                this.isWebXRMode = false;
                this.hideStartContainer();
                this.showControls();
                this.updateStatus('测试模式运行中');
                this.updateDebugInfo('测试模式活跃');
                
                // 添加测试按钮
                this.addTestButtons();
            }
            
            addTestButtons() {
                // 测试加载乐器1
                const testButton1 = document.createElement('button');
                testButton1.textContent = '测试乐器1';
                testButton1.style.cssText = `
                    position: absolute;
                    top: 120px;
                    left: 20px;
                    padding: 10px 15px;
                    background: #FFC107;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    z-index: 10;
                    color: black;
                `;
                testButton1.addEventListener('click', () => {
                    console.log('测试加载乐器1');
                    this.handleQRDetection('pattern1');
                });
                document.body.appendChild(testButton1);
                
                // 测试加载乐器2
                const testButton2 = document.createElement('button');
                testButton2.textContent = '测试乐器2';
                testButton2.style.cssText = `
                    position: absolute;
                    top: 160px;
                    left: 20px;
                    padding: 10px 15px;
                    background: #17a2b8;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    z-index: 10;
                    color: white;
                `;
                testButton2.addEventListener('click', () => {
                    console.log('测试加载乐器2');
                    this.handleQRDetection('pattern2');
                });
                document.body.appendChild(testButton2);
            }
            
            setupControllers() {
                for (let i = 0; i < 2; i++) {
                    const controller = this.renderer.xr.getController(i);
                    controller.addEventListener('select', (event) => {
                        console.log('控制器选择事件');
                        this.onControllerSelect(event);
                    });
                    this.scene.add(controller);
                    this.controllers.push(controller);
                    
                    // 添加控制器射线
                    const geometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, 0, 0),
                        new THREE.Vector3(0, 0, -1)
                    ]);
                    const line = new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
                    controller.add(line);
                }
                console.log('控制器设置完成');
            }
            
            onControllerSelect(event) {
                if (this.activeModel) {
                    this.activeModel.rotation.y += Math.PI / 4;
                    console.log('模型已旋转');
                    this.updateDebugInfo('模型旋转');
                }
            }
            
            async handleQRDetection(qrData) {
                console.log('处理二维码:', qrData);
                this.updateDebugInfo('检测到: ' + qrData);
                
                const config = this.instrumentConfigs[qrData];
                if (!config) {
                    this.updateQRResult('未知二维码: ' + qrData);
                    this.updateDebugInfo('未知码: ' + qrData);
                    return;
                }
                
                this.updateQRResult(qrData);
                this.updateCurrentInstrument(config.name);
                
                await this.switchInstrument(qrData, config);
            }
            
            async switchInstrument(instrumentId, config) {
                try {
                    console.log('切换乐器:', config.name);
                    this.updateDebugInfo('加载: ' + config.name);
                    
                    // 移除当前模型
                    if (this.activeModel) {
                        this.scene.remove(this.activeModel);
                        this.activeModel = null;
                    }
                    
                    // 加载新模型
                    const model = await this.loadModel(config.model);
                    if (model) {
                        // 根据是否是WebXR模式调整位置
                        if (this.isWebXRMode) {
                            model.position.set(0, 0, -2); // WebXR模式：在用户前方
                        } else {
                            model.position.set(0, 0, 0);  // 测试模式：中央
                        }
                        
                        // 使用原始配置的缩放值（和传统AR版本相同）
                        model.scale.set(...config.scale);
                        
                        this.scene.add(model);
                        this.activeModel = model;
                        
                        console.log('GLTF模型加载成功:', config.name, '位置:', model.position, '缩放:', model.scale);
                        this.updateDebugInfo('模型已加载: ' + config.name);
                        
                        // 添加动态材质变化（保持原项目特性）
                        this.addDynamicMaterial(model);
                        
                        // 切换音频
                        await this.audioManager.switchAudio(config.audio);
                        this.updateAudioInfo(config.name);
                        this.enableAudioButton();
                    }
                    
                } catch (error) {
                    console.error('切换乐器失败:', error);
                    this.updateStatus('模型加载失败: ' + error.message);
                    this.updateDebugInfo('加载错误: ' + error.message);
                }
            }
            
            async loadModel(modelPath) {
                if (this.loadedModels.has(modelPath)) {
                    console.log('使用缓存模型:', modelPath);
                    return this.loadedModels.get(modelPath).clone();
                }
                
                if (!this.modelLoader) {
                    throw new Error('GLTFLoader尚未初始化，请稍后再试');
                }
                
                console.log('开始加载GLTF模型:', modelPath);
                this.updateDebugInfo('加载GLTF: ' + modelPath);
                
                return new Promise((resolve, reject) => {
                    this.modelLoader.load(
                        modelPath,
                        (gltf) => {
                            console.log('GLTF模型加载成功:', modelPath);
                            this.updateDebugInfo('GLTF加载成功: ' + modelPath);
                            
                            // 确保模型有正确的材质
                            gltf.scene.traverse((child) => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                    if (child.material) {
                                        child.material.needsUpdate = true;
                                    }
                                }
                            });
                            
                            this.loadedModels.set(modelPath, gltf.scene);
                            resolve(gltf.scene.clone());
                        },
                        (progress) => {
                            if (progress.total > 0) {
                                const percent = (progress.loaded / progress.total * 100).toFixed(1);
                                console.log('GLTF加载进度:', percent + '%');
                                this.updateDebugInfo('加载进度: ' + percent + '%');
                            }
                        },
                        (error) => {
                            console.error('GLTF模型加载失败:', modelPath, error);
                            this.updateDebugInfo('GLTF加载失败: ' + error.message);
                            reject(error);
                        }
                    );
                });
            }
            
            addDynamicMaterial(model) {
                const colors = [0xFF5733, 0x33FF57, 0x3357FF, 0xFFFF33, 0xFF33FF];
                let colorIndex = 0;
                
                const interval = setInterval(() => {
                    if (!model.parent) {
                        clearInterval(interval);
                        return;
                    }
                    
                    model.traverse((child) => {
                        if (child.isMesh && child.material) {
                            colorIndex = (colorIndex + 1) % colors.length;
                            if (child.material.color) {
                                child.material.color.setHex(colors[colorIndex]);
                            }
                        }
                    });
                    console.log('模型颜色变化:', colorIndex);
                }, 3000); // 每3秒变化一次
                
                return interval;
            }
            
            toggleAudio() {
                this.audioManager.togglePlayback();
            }
            
            render() {
                // 旋转测试立方体
                if (this.testCube) {
                    this.testCube.rotation.x += 0.01;
                    this.testCube.rotation.y += 0.01;
                }
                
                // 旋转活跃模型
                if (this.activeModel) {
                    this.activeModel.rotation.y += 0.005;
                }
                
                this.renderer.render(this.scene, this.camera);
            }
            
            // UI辅助方法
            hideStartContainer() {
                document.getElementById('startContainer').style.display = 'none';
            }
            
            showControls() {
                document.getElementById('info').style.display = 'block';
                document.getElementById('audioControls').style.display = 'block';
                document.getElementById('debugInfo').style.display = 'block';
            }
            
            updateStatus(status) {
                document.getElementById('status').textContent = status;
            }
            
            updateQRResult(result) {
                document.getElementById('qrResult').textContent = result;
            }
            
            updateCurrentInstrument(instrument) {
                document.getElementById('currentInstrument').textContent = instrument;
            }
            
            updateAudioInfo(info) {
                document.getElementById('audioInfo').textContent = info;
            }
            
            updateDebugInfo(info) {
                const debugText = document.getElementById('debugText');
                if (debugText) {
                    debugText.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + info + '</div>';
                    debugText.scrollTop = debugText.scrollHeight;
                }
            }
            
            enableAudioButton() {
                const button = document.getElementById('playButton');
                button.disabled = false;
                button.style.backgroundColor = '#007BFF';
            }
        }
        
        // 音频管理器
        class AudioManager {
            constructor() {
                this.audioCache = new Map();
                this.currentAudio = null;
                this.isPlaying = false;
                console.log('AudioManager初始化');
            }
            
            async preloadAudio(configs) {
                console.log('开始预加载音频文件...');
                for (const [key, config] of Object.entries(configs)) {
                    try {
                        const audio = new Audio();
                        audio.src = config.audio;
                        audio.preload = 'auto';
                        
                        await new Promise((resolve, reject) => {
                            audio.oncanplaythrough = () => {
                                console.log('音频预加载成功:', config.audio);
                                resolve();
                            };
                            audio.onerror = (error) => {
                                console.error('音频预加载失败:', config.audio, error);
                                resolve(); // 继续加载其他音频
                            };
                            audio.load();
                        });
                        
                        this.audioCache.set(config.audio, audio);
                    } catch (error) {
                        console.error('音频处理错误:', config.audio, error);
                    }
                }
                console.log('音频预加载完成，已加载', this.audioCache.size, '个音频文件');
            }
            
            async switchAudio(audioPath) {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                
                this.currentAudio = this.audioCache.get(audioPath);
                this.isPlaying = false;
                this.updatePlayButton();
                console.log('切换音频:', audioPath);
            }
            
            togglePlayback() {
                if (!this.currentAudio) {
                    console.log('没有可播放的音频');
                    return;
                }
                
                if (this.isPlaying) {
                    this.currentAudio.pause();
                    this.isPlaying = false;
                    console.log('音频已暂停');
                } else {
                    this.currentAudio.play().then(() => {
                        this.isPlaying = true;
                        console.log('音频开始播放');
                    }).catch((error) => {
                        console.error('音频播放失败:', error);
                    });
                }
                this.updatePlayButton();
            }
            
            updatePlayButton() {
                const button = document.getElementById('playButton');
                if (button) {
                    button.textContent = this.isPlaying ? '暂停' : '播放';
                }
            }
        }
        
        // 二维码检测器
        class QRDetector {
            constructor() {
                this.canvas = null;
                this.context = null;
                this.video = null;
                this.isDetecting = false;
                this.onDetectionCallback = null;
                console.log('QRDetector初始化');
            }
            
            init() {
                this.canvas = document.getElementById('qrCanvas');
                this.context = this.canvas.getContext('2d');
                this.canvas.width = 640;
                this.canvas.height = 480;
                console.log('QRDetector设置完成');
            }
            
            async startDetection(callback) {
                this.onDetectionCallback = callback;
                console.log('开始二维码检测');
                // 此处可以添加实际的摄像头二维码检测逻辑
            }
            
            stopDetection() {
                this.isDetecting = false;
                if (this.video && this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                }
                console.log('二维码检测已停止');
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化...');
            console.log('THREE版本:', THREE.REVISION);
            console.log('jsQR可用:', typeof jsQR !== 'undefined');
            console.log('WebXR可用:', !!navigator.xr);
            console.log('GLTFLoader状态:', window.gltfLoaderReady ? '已加载' : '加载中...');
            
            try {
                app = new WebXRARInstrument();
                window.app = app; // 设置全局引用供GLTFLoader回调使用
            } catch (error) {
                console.error('应用初始化失败:', error);
                document.getElementById('startContainer').innerHTML = 
                    '<h2>初始化失败</h2><p>错误: ' + error.message + '</p>' +
                    '<button onclick="location.reload()">重新加载</button>';
            }
        });
        
        // 错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全局错误捕获:", {
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error
            });
            
            if (app) {
                app.updateDebugInfo('错误: ' + message);
            }
        };
    </script>
</body>
</html>