<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>岭南乐器WebXR增强现实视听工具</title>
    
    <!-- 本地Three.js文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="./js/GLTFLoader.js"></script>
    <script src="./js/DRACOLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    
    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #startContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }
        
        #startWebXR {
            padding: 20px 40px;
            font-size: 18px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }
        
        #fallbackAR {
            padding: 15px 30px;
            font-size: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10;
            display: none;
        }
        
        #audioControls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            display: none;
        }
        
        #playButton {
            padding: 10px 20px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #playButton:disabled {
            background: grey;
            cursor: not-allowed;
        }
        
        #debugInfo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        #qrCanvas {
            display: none;
        }
        
        .download-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,0,0.9);
            color: black;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="download-info" id="downloadInfo">
        <strong>文件状态检查中...</strong><br>
        <span id="fileStatus">正在检查本地文件...</span><br>
        <a href="#" onclick="showDownloadLinks()">查看下载说明</a>
    </div>
    
    <div id="startContainer">
        <h2>岭南乐器WebXR体验</h2>
        <p>请选择体验模式：</p>
        <button id="startWebXR">启动WebXR模式</button>
        <br>
        <button id="fallbackAR">测试模式</button>
        <p><small>WebXR模式需要VR头显支持</small></p>
    </div>
    
    <div id="info">
        <div>状态: <span id="status">准备就绪</span></div>
        <div>检测到的码: <span id="qrResult">无</span></div>
        <div>当前乐器: <span id="currentInstrument">无</span></div>
        <div id="instructionText">请将二维码置于视野中心</div>
    </div>
    
    <div id="audioControls">
        <button id="playButton" disabled>播放</button>
        <span id="audioInfo">无音频</span>
    </div>
    
    <div id="debugInfo">
        <div>调试信息:</div>
        <div id="debugText"></div>
    </div>
    
    <canvas id="qrCanvas"></canvas>

    <script>
        // 显示下载链接的函数
        function showDownloadLinks() {
            const links = `
本地文件下载说明：

请下载以下文件并放置到对应目录：

1. 创建 js/ 目录，下载：
   GLTFLoader.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/loaders/GLTFLoader.js
   DRACOLoader.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/loaders/DRACOLoader.js

2. 创建 js/draco/gltf/ 目录，下载：
   draco_decoder.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_decoder.js
   draco_decoder.wasm → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_decoder.wasm
   draco_encoder.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_encoder.js
   draco_wasm_wrapper.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_wasm_wrapper.js

最终文件结构：
/WEB-AR-MR/
├── index.html
├── js/
│   ├── GLTFLoader.js
│   ├── DRACOLoader.js
│   └── draco/gltf/
│       ├── draco_decoder.js
│       ├── draco_decoder.wasm
│       ├── draco_encoder.js
│       └── draco_wasm_wrapper.js
├── model1.gltf
├── model2.gltf
├── audio1.mp3
└── audio2.mp3
            `;
            alert(links);
        }
        
        // 全局变量
        let app = null;
        
        // 主应用类
        class WebXRARInstrument {
            constructor() {
                console.log('开始初始化WebXRARInstrument...');
                
                // 基础属性
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.xrSession = null;
                this.referenceSpace = null;
                this.controllers = [];
                this.currentInstrument = null;
                this.isWebXRMode = false;
                this.modelLoader = null;
                
                // 乐器配置
                this.instrumentConfigs = {
                    'pattern1': {
                        model: 'model1.gltf',
                        audio: 'audio1.mp3',
                        info: 'info1.txt',
                        scale: [0.02, 0.02, 0.02],
                        name: '乐器1'
                    },
                    'pattern2': {
                        model: 'model2.gltf', 
                        audio: 'audio2.mp3',
                        info: 'info2.txt',
                        scale: [0.03, 0.03, 0.03],
                        name: '乐器2'
                    }
                };
                
                this.loadedModels = new Map();
                this.activeModel = null;
                
                // 初始化模块
                this.audioManager = new AudioManager();
                this.qrDetector = new QRDetector();
                
                this.init();
            }
            
            async init() {
                try {
                    console.log('初始化UI...');
                    this.setupUI();
                    
                    console.log('初始化Three.js...');
                    this.setupThreeJS();
                    
                    console.log('检查本地文件...');
                    this.checkLocalFiles();
                    
                    console.log('初始化GLTFLoader...');
                    this.initializeLoader();
                    
                    console.log('预加载音频...');
                    await this.audioManager.preloadAudio(this.instrumentConfigs);
                    
                    console.log('初始化二维码检测器...');
                    this.qrDetector.init();
                    
                    console.log('WebXRARInstrument初始化完成');
                    this.updateDebugInfo('初始化完成');
                    
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.updateDebugInfo('初始化失败: ' + error.message);
                }
            }
            
            checkLocalFiles() {
                const fileStatus = document.getElementById('fileStatus');
                let status = [];
                
                if (typeof THREE.GLTFLoader !== 'undefined') {
                    status.push('✅ GLTFLoader');
                } else {
                    status.push('❌ GLTFLoader');
                }
                
                if (typeof THREE.DRACOLoader !== 'undefined') {
                    status.push('✅ DRACOLoader');
                } else {
                    status.push('❌ DRACOLoader');
                }
                
                fileStatus.innerHTML = status.join('<br>');
                
                if (status.some(s => s.includes('❌'))) {
                    document.getElementById('downloadInfo').style.backgroundColor = '#ff6b6b';
                } else {
                    document.getElementById('downloadInfo').style.backgroundColor = '#90EE90';
                    setTimeout(() => {
                        document.getElementById('downloadInfo').style.display = 'none';
                    }, 3000);
                }
            }
            
            initializeLoader() {
                try {
                    if (typeof THREE.GLTFLoader === 'function') {
                        this.modelLoader = new THREE.GLTFLoader();
                        
                        if (typeof THREE.DRACOLoader === 'function') {
                            const dracoLoader = new THREE.DRACOLoader();
                            dracoLoader.setDecoderPath('./js/draco/gltf/');
                            dracoLoader.preload();
                            this.modelLoader.setDRACOLoader(dracoLoader);
                            
                            console.log('GLTFLoader和DRACOLoader初始化成功（本地文件）');
                            this.updateDebugInfo('GLTFLoader + DRACOLoader: 本地就绪');
                        } else {
                            console.log('GLTFLoader初始化成功（无DRACOLoader）');
                            this.updateDebugInfo('GLTFLoader: 已就绪（无Draco支持）');
                        }
                        
                    } else {
                        console.error('GLTFLoader未找到，请检查js/GLTFLoader.js文件');
                        this.updateDebugInfo('GLTFLoader: 文件缺失');
                    }
                } catch (error) {
                    console.error('GLTFLoader初始化失败:', error);
                    this.updateDebugInfo('GLTFLoader: 初始化错误');
                }
            }
            
            setupUI() {
                const startWebXR = document.getElementById('startWebXR');
                const fallbackAR = document.getElementById('fallbackAR');
                const playButton = document.getElementById('playButton');
                
                startWebXR.addEventListener('click', () => {
                    console.log('启动WebXR按钮被点击');
                    this.updateDebugInfo('尝试启动WebXR...');
                    this.startWebXR();
                });
                
                fallbackAR.addEventListener('click', () => {
                    console.log('测试模式按钮被点击');
                    this.updateDebugInfo('启动测试模式...');
                    this.startTestMode();
                });
                
                playButton.addEventListener('click', () => {
                    console.log('播放按钮被点击');
                    this.toggleAudio();
                });
                
                console.log('UI事件监听器已设置');
            }
            
            setupThreeJS() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x202020);
                
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 1.6, 3);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(this.renderer.domElement);
                
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x444444);
                gridHelper.position.y = -1;
                this.scene.add(gridHelper);
                
                const testGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const testMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x00ff00,
                    transparent: true,
                    opacity: 0.5
                });
                this.testCube = new THREE.Mesh(testGeometry, testMaterial);
                this.testCube.position.set(2, 0, -1);
                this.scene.add(this.testCube);
                
                this.renderer.setAnimationLoop(() => this.render());
                
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                console.log('Three.js设置完成');
            }
            
            async startWebXR() {
                if (!navigator.xr) {
                    alert('此设备不支持WebXR，请尝试测试模式');
                    return;
                }
                
                try {
                    const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                    const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    
                    if (!vrSupported && !arSupported) {
                        alert('此设备不支持WebXR，请尝试测试模式');
                        return;
                    }
                    
                    const sessionMode = vrSupported ? 'immersive-vr' : 'immersive-ar';
                    this.xrSession = await navigator.xr.requestSession(sessionMode, {
                        requiredFeatures: ['local'],
                        optionalFeatures: ['bounded-floor', 'hand-tracking']
                    });
                    
                    await this.renderer.xr.setSession(this.xrSession);
                    this.referenceSpace = await this.xrSession.requestReferenceSpace('local');
                    
                    this.setupControllers();
                    this.isWebXRMode = true;
                    this.hideStartContainer();
                    this.showControls();
                    this.addTestButtons();
                    
                    this.updateStatus('WebXR运行中');
                    
                } catch (error) {
                    console.error('WebXR启动失败:', error);
                    alert('WebXR启动失败: ' + error.message);
                }
            }
            
            startTestMode() {
                this.isWebXRMode = false;
                this.hideStartContainer();
                this.showControls();
                this.addTestButtons();
                this.updateStatus('测试模式运行中');
            }
            
            addTestButtons() {
                const testButton1 = document.createElement('button');
                testButton1.textContent = '测试乐器1';
                testButton1.style.cssText = `
                    position: absolute; top: 120px; left: 20px; padding: 10px 15px;
                    background: #FFC107; border: none; border-radius: 5px;
                    cursor: pointer; z-index: 10; color: black;
                `;
                testButton1.addEventListener('click', () => this.handleQRDetection('pattern1'));
                document.body.appendChild(testButton1);
                
                const testButton2 = document.createElement('button');
                testButton2.textContent = '测试乐器2';
                testButton2.style.cssText = `
                    position: absolute; top: 160px; left: 20px; padding: 10px 15px;
                    background: #17a2b8; border: none; border-radius: 5px;
                    cursor: pointer; z-index: 10; color: white;
                `;
                testButton2.addEventListener('click', () => this.handleQRDetection('pattern2'));
                document.body.appendChild(testButton2);
            }
            
            setupControllers() {
                for (let i = 0; i < 2; i++) {
                    const controller = this.renderer.xr.getController(i);
                    controller.addEventListener('select', (event) => this.onControllerSelect(event));
                    this.scene.add(controller);
                    this.controllers.push(controller);
                    
                    const geometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, 0, 0),
                        new THREE.Vector3(0, 0, -1)
                    ]);
                    const line = new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
                    controller.add(line);
                }
            }
            
            onControllerSelect(event) {
                if (this.activeModel) {
                    this.activeModel.rotation.y += Math.PI / 4;
                    console.log('模型已旋转');
                }
            }
            
            async handleQRDetection(qrData) {
                console.log('处理二维码:', qrData);
                
                const config = this.instrumentConfigs[qrData];
                if (!config) {
                    this.updateQRResult('未知二维码: ' + qrData);
                    return;
                }
                
                this.updateQRResult(qrData);
                this.updateCurrentInstrument(config.name);
                await this.switchInstrument(qrData, config);
            }
            
            async switchInstrument(instrumentId, config) {
                try {
                    if (this.activeModel) {
                        this.scene.remove(this.activeModel);
                        this.activeModel = null;
                    }
                    
                    const model = await this.loadModel(config.model);
                    if (model) {
                        if (this.isWebXRMode) {
                            model.position.set(0, 0, -2);
                        } else {
                            model.position.set(0, 0, 0);
                        }
                        
                        model.scale.set(...config.scale);
                        this.scene.add(model);
                        this.activeModel = model;
                        
                        this.addDynamicMaterial(model);
                        await this.audioManager.switchAudio(config.audio);
                        this.updateAudioInfo(config.name);
                        this.enableAudioButton();
                        
                        console.log('乐器加载成功:', config.name);
                    }
                    
                } catch (error) {
                    console.error('切换乐器失败:', error);
                    this.updateStatus('模型加载失败: ' + error.message);
                }
            }
            
            async loadModel(modelPath) {
                if (this.loadedModels.has(modelPath)) {
                    return this.loadedModels.get(modelPath).clone();
                }
                
                if (!this.modelLoader) {
                    throw new Error('GLTFLoader尚未初始化');
                }
                
                return new Promise((resolve, reject) => {
                    this.modelLoader.load(
                        modelPath,
                        (gltf) => {
                            gltf.scene.traverse((child) => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                }
                            });
                            
                            this.loadedModels.set(modelPath, gltf.scene);
                            resolve(gltf.scene.clone());
                        },
                        (progress) => {
                            if (progress.total > 0) {
                                const percent = (progress.loaded / progress.total * 100).toFixed(1);
                                console.log('加载进度:', percent + '%');
                            }
                        },
                        (error) => {
                            console.error('GLTF加载失败:', error);
                            const fallbackModel = this.createFallbackModel(modelPath);
                            resolve(fallbackModel);
                        }
                    );
                });
            }
            
            createFallbackModel(modelPath) {
                const group = new THREE.Group();
                
                if (modelPath.includes('model1')) {
                    const geometry = new THREE.BoxGeometry(1, 0.3, 2);
                    const material = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
                    const piano = new THREE.Mesh(geometry, material);
                    group.add(piano);
                    
                    for (let i = 0; i < 7; i++) {
                        const keyGeometry = new THREE.BoxGeometry(0.1, 0.05, 0.3);
                        const keyMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                        const key = new THREE.Mesh(keyGeometry, keyMaterial);
                        key.position.set(-0.35 + i * 0.12, 0.2, 0.8);
                        group.add(key);
                    }
                } else {
                    const geometry = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 16);
                    const material = new THREE.MeshPhongMaterial({ color: 0x696969 });
                    const drum = new THREE.Mesh(geometry, material);
                    group.add(drum);
                    
                    const topGeometry = new THREE.CircleGeometry(0.8, 16);
                    const topMaterial = new THREE.MeshPhongMaterial({ color: 0xF5DEB3 });
                    const drumTop = new THREE.Mesh(topGeometry, topMaterial);
                    drumTop.rotation.x = -Math.PI / 2;
                    drumTop.position.y = 0.25;
                    group.add(drumTop);
                }
                
                return group;
            }
            
            addDynamicMaterial(model) {
                const colors = [0xFF5733, 0x33FF57, 0x3357FF, 0xFFFF33, 0xFF33FF];
                let colorIndex = 0;
                
                const interval = setInterval(() => {
                    if (!model.parent) {
                        clearInterval(interval);
                        return;
                    }
                    
                    model.traverse((child) => {
                        if (child.isMesh && child.material && child.material.color) {
                            colorIndex = (colorIndex + 1) % colors.length;
                            child.material.color.setHex(colors[colorIndex]);
                        }
                    });
                }, 3000);
            }
            
            toggleAudio() {
                this.audioManager.togglePlayback();
            }
            
            render() {
                if (this.testCube) {
                    this.testCube.rotation.x += 0.01;
                    this.testCube.rotation.y += 0.01;
                }
                
                if (this.activeModel) {
                    this.activeModel.rotation.y += 0.005;
                }
                
                this.renderer.render(this.scene, this.camera);
            }
            
            hideStartContainer() {
                document.getElementById('startContainer').style.display = 'none';
            }
            
            showControls() {
                document.getElementById('info').style.display = 'block';
                document.getElementById('audioControls').style.display = 'block';
                document.getElementById('debugInfo').style.display = 'block';
            }
            
            updateStatus(status) {
                document.getElementById('status').textContent = status;
            }
            
            updateQRResult(result) {
                document.getElementById('qrResult').textContent = result;
            }
            
            updateCurrentInstrument(instrument) {
                document.getElementById('currentInstrument').textContent = instrument;
            }
            
            updateAudioInfo(info) {
                document.getElementById('audioInfo').textContent = info;
            }
            
            updateDebugInfo(info) {
                const debugText = document.getElementById('debugText');
                if (debugText) {
                    debugText.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + info + '</div>';
                    debugText.scrollTop = debugText.scrollHeight;
                }
            }
            
            enableAudioButton() {
                const button = document.getElementById('playButton');
                button.disabled = false;
                button.style.backgroundColor = '#007BFF';
            }
        }
        
        // 音频管理器
        class AudioManager {
            constructor() {
                this.audioCache = new Map();
                this.currentAudio = null;
                this.isPlaying = false;
            }
            
            async preloadAudio(configs) {
                for (const [key, config] of Object.entries(configs)) {
                    try {
                        const audio = new Audio();
                        audio.src = config.audio;
                        audio.preload = 'auto';
                        
                        await new Promise((resolve) => {
                            audio.oncanplaythrough = resolve;
                            audio.onerror = resolve;
                            audio.load();
                        });
                        
                        this.audioCache.set(config.audio, audio);
                    } catch (error) {
                        console.error('音频处理错误:', error);
                    }
                }
            }
            
            async switchAudio(audioPath) {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                
                this.currentAudio = this.audioCache.get(audioPath);
                this.isPlaying = false;
                this.updatePlayButton();
            }
            
            togglePlayback() {
                if (!this.currentAudio) return;
                
                if (this.isPlaying) {
                    this.currentAudio.pause();
                    this.isPlaying = false;
                } else {
                    this.currentAudio.play().then(() => {
                        this.isPlaying = true;
                    }).catch((error) => {
                        console.error('音频播放失败:', error);
                    });
                }
                this.updatePlayButton();
            }
            
            updatePlayButton() {
                const button = document.getElementById('playButton');
                if (button) {
                    button.textContent = this.isPlaying ? '暂停' : '播放';
                }
            }
        }
        
        // 二维码检测器
        class QRDetector {
            constructor() {
                this.canvas = null;
                this.context = null;
            }
            
            init() {
                this.canvas = document.getElementById('qrCanvas');
                this.context = this.canvas.getContext('2d');
                this.canvas.width = 640;
                this.canvas.height = 480;
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化...');
            console.log('THREE版本:', THREE.REVISION);
            console.log('jsQR可用:', typeof jsQR !== 'undefined');
            console.log('WebXR可用:', !!navigator.xr);
            console.log('GLTFLoader可用:', typeof THREE.GLTFLoader !== 'undefined');
            console.log('DRACOLoader可用:', typeof THREE.DRACOLoader !== 'undefined');
            
            try {
                app = new WebXRARInstrument();
            } catch (error) {
                console.error('应用初始化失败:', error);
                document.getElementById('startContainer').innerHTML = 
                    '<h2>初始化失败</h2><p>错误: ' + error.message + '</p>' +
                    '<button onclick="location.reload()">重新加载</button>' +
                    '<br><br><button onclick="showDownloadLinks()">查看下载说明</button>';
            }
        });
        
        // 错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全局错误捕获:", {
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error
            });
        };
    </script>
</body>
</html>