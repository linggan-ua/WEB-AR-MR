<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>岭南乐器WebXR增强现实视听工具</title>
    
    <!-- 本地Three.js文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="./js/GLTFLoader.js"></script>
    <script src="./js/DRACOLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    
    <!-- 备份Three.js r128以防被A-Frame覆盖 -->
    <script>
        window.THREE_R128 = THREE;
        console.log('THREE r128已备份');
    </script>
    
    <!-- AR.js库 -->
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- 恢复Three.js r128的WebXR功能 -->
    <script>
        // 恢复WebXR功能
        if (window.THREE_R128 && window.THREE_R128.WebXRManager) {
            THREE.WebXRManager = window.THREE_R128.WebXRManager;
            if (THREE.WebGLRenderer && THREE.WebGLRenderer.prototype) {
                THREE.WebGLRenderer.prototype.xr = window.THREE_R128.WebGLRenderer.prototype.xr;
            }
            console.log('WebXR功能已恢复');
        }
        
        // 确保jsQR可用
        if (typeof jsQR === 'undefined') {
            console.error('jsQR未加载，将尝试重新加载');
        }
    </script>
    
    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #startContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }
        
        #startWebXR {
            padding: 20px 40px;
            font-size: 18px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }
        
        #fallbackAR {
            padding: 15px 30px;
            font-size: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        
        #cameraAR {
            padding: 15px 30px;
            font-size: 16px;
            background: #fd7e14;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        
        #realAR {
            padding: 15px 30px;
            font-size: 16px;
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10;
            display: none;
        }
        
        #audioControls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            display: none;
        }
        
        #playButton {
            padding: 10px 20px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #playButton:disabled {
            background: grey;
            cursor: not-allowed;
        }
        
        #debugInfo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        #qrCanvas {
            display: none;
        }
        
        #cameraVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        
        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            z-index: 5;
            display: none;
        }
        
        .camera-overlay::before {
            content: '将二维码放在框内';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* AR.js场景样式 */
        #arScene {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .ar-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            color: white;
        }
        
        .ar-controls button {
            padding: 8px 15px;
            margin: 5px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .ar-controls button:disabled {
            background: grey;
            cursor: not-allowed;
        }
        
        .ar-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            color: white;
            max-width: 300px;
        }
        
        .download-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,0,0.9);
            color: black;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="download-info" id="downloadInfo">
        <strong>文件状态检查中...</strong><br>
        <span id="fileStatus">正在检查本地文件...</span><br>
        <a href="#" onclick="showDownloadLinks()">查看下载说明</a>
    </div>
    
    <div id="startContainer">
        <h2>岭南乐器WebXR体验</h2>
        <p>请选择体验模式：</p>
        <button id="startWebXR">启动WebXR模式</button>
        <br>
        <button id="realAR">传统AR模式（完整追踪）</button>
        <br>
        <button id="cameraAR">摄像头AR模式</button>
        <br>
        <button id="fallbackAR">测试模式</button>
        <p><small>
            WebXR模式需要VR头显支持<br>
            传统AR模式使用AR.js精确追踪<br>
            摄像头AR模式需要摄像头权限
        </small></p>
    </div>
    
    <div id="info">
        <div>状态: <span id="status">准备就绪</span></div>
        <div>检测到的码: <span id="qrResult">无</span></div>
        <div>当前乐器: <span id="currentInstrument">无</span></div>
        <div id="instructionText">请将二维码置于视野中心</div>
    </div>
    
    <div id="audioControls">
        <button id="playButton" disabled>播放</button>
        <span id="audioInfo">无音频</span>
    </div>
    
    <div id="debugInfo">
        <div>调试信息:</div>
        <div id="debugText"></div>
    </div>
    
    <canvas id="qrCanvas"></canvas>
    <video id="cameraVideo" autoplay muted playsinline></video>
    <div class="camera-overlay" id="cameraOverlay"></div>
    
    <!-- 真正的AR.js场景 - 完全还原用户原始代码 -->
    <div id="arScene">
        <!-- AR.js控制面板 -->
        <div class="ar-controls">
            <button id="arPlayButton" disabled>播放</button>
            <button id="stopARButton">退出AR</button>
        </div>
        
        <!-- AR.js信息显示 -->
        <div class="ar-info" id="arInfo">
            请用摄像头对准"岭南乐器码"
        </div>
        
        <!-- A-Frame AR场景 - 使用用户原始配置 -->
        <a-scene 
            arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" 
            embedded 
            vr-mode-ui="enabled: false"
            id="aframeScene">
            
            <!-- 乐器1标记 -->
            <a-marker 
                id="marker1" 
                preset="custom" 
                ar-marker-tracker
                url="pattern1.patt">
                <a-entity 
                    gltf-model="model1.gltf" 
                    id="model1" 
                    dynamic-rotation="x:0; y:0; z:0" 
                    position="0 0 0" 
                    scale="0.02 0.02 0.02"
                    dynamic-material
                    dynamic-light="intensity: 1">
                </a-entity>
            </a-marker>
            
            <!-- 乐器2标记 -->
            <a-marker 
                id="marker2" 
                preset="custom" 
                ar-marker-tracker
                url="pattern2.patt">
                <a-entity 
                    gltf-model="model2.gltf" 
                    id="model2" 
                    dynamic-rotation="x:0; y:0; z:0" 
                    position="0 0 0" 
                    scale="0.03 0.03 0.03"
                    dynamic-material
                    dynamic-light="intensity: 1">
                </a-entity>
            </a-marker>
            
            <!-- 摄像头 -->
            <a-entity camera></a-entity>
        </a-scene>
    </div>

    <script>
        // 显示下载链接的函数
        function showDownloadLinks() {
            const links = `
本地文件下载说明：

请下载以下文件并放置到对应目录：

1. 创建 js/ 目录，下载：
   GLTFLoader.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/loaders/GLTFLoader.js
   DRACOLoader.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/loaders/DRACOLoader.js

2. 创建 js/draco/gltf/ 目录，下载：
   draco_decoder.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_decoder.js
   draco_decoder.wasm → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_decoder.wasm
   draco_encoder.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_encoder.js
   draco_wasm_wrapper.js → https://raw.githubusercontent.com/mrdoob/three.js/r128/examples/js/libs/draco/gltf/draco_wasm_wrapper.js

最终文件结构：
/WEB-AR-MR/
├── index.html
├── js/
│   ├── GLTFLoader.js
│   ├── DRACOLoader.js
│   └── draco/gltf/
│       ├── draco_decoder.js
│       ├── draco_decoder.wasm
│       ├── draco_encoder.js
│       └── draco_wasm_wrapper.js
├── model1.gltf
├── model2.gltf
├── audio1.mp3
└── audio2.mp3
            `;
            alert(links);
        }
        
        // 全局变量
        let app = null;
        
        // 主应用类
        class WebXRARInstrument {
            constructor() {
                console.log('开始初始化WebXRARInstrument...');
                
                // 基础属性
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.xrSession = null;
                this.referenceSpace = null;
                this.controllers = [];
                this.currentInstrument = null;
                this.isWebXRMode = false;
                this.isCameraARMode = false;
                this.isRealARMode = false;
                this.modelLoader = null;
                this.mouseControls = null;
                
                // AR.js相关
                this.arAudioCache = new Map();
                this.arCurrentAudio = null;
                this.arIsPlaying = false;
                
                // 乐器配置
                this.instrumentConfigs = {
                    'pattern1': {
                        model: 'model1.gltf',
                        audio: 'audio1.mp3',
                        info: 'info1.txt',
                        scale: [0.02, 0.02, 0.02],
                        name: '乐器1'
                    },
            
            async startRealAR() {
                try {
                    console.log('启动传统AR模式（完整追踪）...');
                    this.updateDebugInfo('初始化AR.js组件...');
                    
                    // 注册用户原始的A-Frame组件
                    this.registerARComponents();
                    
                    // 预加载AR音频
                    await this.preloadARAssets();
                    
                    // 显示AR场景
                    document.getElementById('arScene').style.display = 'block';
                    document.getElementById('startContainer').style.display = 'none';
                    
                    // 设置AR控制按钮
                    this.setupARControls();
                    
                    this.isRealARMode = true;
                    this.updateDebugInfo('传统AR模式启动成功 - 使用pattern文件追踪');
                    
                    console.log('传统AR模式启动完成');
                    
                } catch (error) {
                    console.error('传统AR启动失败:', error);
                    this.updateDebugInfo('AR启动失败: ' + error.message);
                    alert('AR启动失败，请尝试其他模式');
                }
            },
            
            registerARComponents() {
                // 还原用户原始的动态旋转组件
                AFRAME.registerComponent('dynamic-rotation', {
                    schema: {
                        x: { type: 'number', default: 0 },
                        y: { type: 'number', default: 0 },
                        z: { type: 'number', default: 0 }
                    },
                    init: function () {
                        const el = this.el;
                        const data = this.data;
                        el.addEventListener('model-loaded', function () {
                            const mesh = el.getObject3D('mesh');
                            if (!mesh) return;
                            mesh.rotation.set(
                                THREE.Math.degToRad(data.x),
                                THREE.Math.degToRad(data.y),
                                THREE.Math.degToRad(data.z)
                            );
                        });
                    }
                });
                
                // 还原用户原始的AR标记追踪组件
                AFRAME.registerComponent('ar-marker-tracker', {
                    init: function () {
                        const el = this.el;
                        const markerId = el.getAttribute('id');
                        let currentAudio = null;
                        let audioPath = '';
                        let infoPath = '';
                        let infoText = '';
                        let isVisible = false;
                        
                        // 根据markerId设置音频和信息路径
                        if (markerId === 'marker1') {
                            audioPath = 'audio1.mp3';
                            infoPath = 'info1.txt';
                        } else if (markerId === 'marker2') {
                            audioPath = 'audio2.mp3';
                            infoPath = 'info2.txt';
                        }
                        
                        // 获取音频
                        if (window.app && window.app.arAudioCache.has(audioPath)) {
                            currentAudio = window.app.arAudioCache.get(audioPath);
                        }
                        
                        // 加载信息文本
                        fetch(infoPath)
                            .then(response => response.ok ? response.text() : '')
                            .then(text => {
                                infoText = text;
                            })
                            .catch(error => {
                                console.error('Error loading info text:', error);
                            });
                        
                        // 监听标记可见性变化
                        this.tick = AFRAME.utils.throttleTick(function () {
                            const newVisible = el.object3D.visible;
                            if (newVisible !== isVisible) {
                                isVisible = newVisible;
                                
                                if (isVisible) {
                                    // 标记出现
                                    console.log('标记出现:', markerId);
                                    
                                    // 切换当前音频
                                    if (window.app) {
                                        if (window.app.arCurrentAudio && window.app.arCurrentAudio !== currentAudio) {
                                            window.app.arCurrentAudio.pause();
                                            window.app.arIsPlaying = false;
                                        }
                                        
                                        window.app.arCurrentAudio = currentAudio;
                                        window.app.updateARInfo(infoText || '检测到乐器标记');
                                        window.app.enableARPlayButton();
                                    }
                                } else {
                                    // 标记消失
                                    console.log('标记消失:', markerId);
                                }
                            }
                        }, 100);
                    }
                });
                
                // 还原用户原始的动态材质组件
                AFRAME.registerComponent('dynamic-material', {
                    init: function () {
                        const el = this.el;
                        let colorIndex = 0;
                        const colors = ['#FF5733', '#33FF57', '#3357FF'];
                        
                        setInterval(function () {
                            colorIndex = (colorIndex + 1) % colors.length;
                            el.setAttribute('material', 'color', colors[colorIndex]);
                        }, 3000);
                    }
                });
                
                // 还原用户原始的动态光照组件
                AFRAME.registerComponent('dynamic-light', {
                    schema: {
                        intensity: { type: 'number', default: 1 }
                    },
                    init: function () {
                        const light = this.el.getOrCreateObject3D('light', THREE.PointLight);
                        light.intensity = this.data.intensity;
                        
                        // 动态调整光照强度
                        setInterval(() => {
                            light.intensity = 0.5 + Math.sin(Date.now() * 0.001) * 0.5;
                        }, 100);
                    },
                    update: function () {
                        const light = this.el.getObject3D('light');
                        if (light) {
                            light.intensity = this.data.intensity;
                        }
                    }
                });
                
                console.log('AR.js组件注册完成');
            },
            
            async preloadARAssets() {
                console.log('预加载AR音频资源...');
                const audioFiles = ['audio1.mp3', 'audio2.mp3'];
                
                for (const audioPath of audioFiles) {
                    try {
                        const audio = new Audio();
                        audio.src = audioPath;
                        audio.preload = 'auto';
                        
                        await new Promise((resolve) => {
                            audio.oncanplaythrough = resolve;
                            audio.onerror = resolve;
                            audio.load();
                        });
                        
                        this.arAudioCache.set(audioPath, audio);
                        console.log('AR音频预加载成功:', audioPath);
                        
                    } catch (error) {
                        console.error('AR音频预加载失败:', audioPath, error);
                    }
                }
            },
            
            setupARControls() {
                const arPlayButton = document.getElementById('arPlayButton');
                const stopARButton = document.getElementById('stopARButton');
                
                arPlayButton.addEventListener('click', () => {
                    this.toggleARAudio();
                });
                
                stopARButton.addEventListener('click', () => {
                    this.stopRealAR();
                });
            },
            
            toggleARAudio() {
                if (!this.arCurrentAudio) {
                    console.log('没有可播放的AR音频');
                    return;
                }
                
                if (this.arIsPlaying) {
                    this.arCurrentAudio.pause();
                    this.arIsPlaying = false;
                    document.getElementById('arPlayButton').textContent = '播放';
                } else {
                    this.arCurrentAudio.play().then(() => {
                        this.arIsPlaying = true;
                        document.getElementById('arPlayButton').textContent = '暂停';
                    }).catch((error) => {
                        console.error('AR音频播放失败:', error);
                    });
                }
            },
            
            enableARPlayButton() {
                const button = document.getElementById('arPlayButton');
                button.disabled = false;
                button.style.backgroundColor = '#007BFF';
                button.textContent = this.arIsPlaying ? '暂停' : '播放';
            },
            
            updateARInfo(text) {
                document.getElementById('arInfo').textContent = text;
            },
            
            stopRealAR() {
                // 停止AR模式
                document.getElementById('arScene').style.display = 'none';
                document.getElementById('startContainer').style.display = 'block';
                
                // 停止音频
                if (this.arCurrentAudio) {
                    this.arCurrentAudio.pause();
                    this.arCurrentAudio.currentTime = 0;
                    this.arIsPlaying = false;
                }
                
                this.isRealARMode = false;
                console.log('传统AR模式已停止');
            },
                    'pattern2': {
                        model: 'model2.gltf', 
                        audio: 'audio2.mp3',
                        info: 'info2.txt',
                        scale: [0.03, 0.03, 0.03],
                        name: '乐器2'
                    }
                };
                
                this.loadedModels = new Map();
                this.activeModel = null;
                
                // 初始化模块
                this.audioManager = new AudioManager();
                this.qrDetector = new QRDetector();
                
                this.init();
            }
            
            async init() {
                try {
                    console.log('初始化UI...');
                    this.setupUI();
                    
                    console.log('初始化Three.js...');
                    this.setupThreeJS();
                    
                    console.log('检查本地文件...');
                    this.checkLocalFiles();
                    
                    console.log('初始化GLTFLoader...');
                    this.initializeLoader();
                    
                    console.log('预加载音频...');
                    await this.audioManager.preloadAudio(this.instrumentConfigs);
                    
                    console.log('初始化二维码检测器...');
                    this.qrDetector.init();
                    
                    console.log('WebXRARInstrument初始化完成');
                    this.updateDebugInfo('初始化完成');
                    
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.updateDebugInfo('初始化失败: ' + error.message);
                }
            }
            
            checkLocalFiles() {
                const fileStatus = document.getElementById('fileStatus');
                let status = [];
                
                if (typeof THREE.GLTFLoader !== 'undefined') {
                    status.push('✅ GLTFLoader');
                } else {
                    status.push('❌ GLTFLoader');
                }
                
                if (typeof THREE.DRACOLoader !== 'undefined') {
                    status.push('✅ DRACOLoader');
                } else {
                    status.push('❌ DRACOLoader');
                }
                
                fileStatus.innerHTML = status.join('<br>');
                
                if (status.some(s => s.includes('❌'))) {
                    document.getElementById('downloadInfo').style.backgroundColor = '#ff6b6b';
                } else {
                    document.getElementById('downloadInfo').style.backgroundColor = '#90EE90';
                    setTimeout(() => {
                        document.getElementById('downloadInfo').style.display = 'none';
                    }, 3000);
                }
            }
            
            initializeLoader() {
                try {
                    if (typeof THREE.GLTFLoader === 'function') {
                        this.modelLoader = new THREE.GLTFLoader();
                        
                        if (typeof THREE.DRACOLoader === 'function') {
                            const dracoLoader = new THREE.DRACOLoader();
                            dracoLoader.setDecoderPath('./js/draco/gltf/');
                            dracoLoader.preload();
                            this.modelLoader.setDRACOLoader(dracoLoader);
                            
                            console.log('GLTFLoader和DRACOLoader初始化成功（本地文件）');
                            this.updateDebugInfo('GLTFLoader + DRACOLoader: 本地就绪');
                        } else {
                            console.log('GLTFLoader初始化成功（无DRACOLoader）');
                            this.updateDebugInfo('GLTFLoader: 已就绪（无Draco支持）');
                        }
                        
                    } else {
                        console.error('GLTFLoader未找到，请检查js/GLTFLoader.js文件');
                        this.updateDebugInfo('GLTFLoader: 文件缺失');
                    }
                } catch (error) {
                    console.error('GLTFLoader初始化失败:', error);
                    this.updateDebugInfo('GLTFLoader: 初始化错误');
                }
            }
            
            setupUI() {
                const startWebXR = document.getElementById('startWebXR');
                const realAR = document.getElementById('realAR');
                const cameraAR = document.getElementById('cameraAR');
                const fallbackAR = document.getElementById('fallbackAR');
                const playButton = document.getElementById('playButton');
                
                startWebXR.addEventListener('click', () => {
                    console.log('启动WebXR按钮被点击');
                    this.updateDebugInfo('尝试启动WebXR...');
                    this.startWebXR();
                });
                
                realAR.addEventListener('click', () => {
                    console.log('传统AR按钮被点击');
                    this.updateDebugInfo('启动传统AR模式...');
                    this.startRealAR();
                });
                
                cameraAR.addEventListener('click', () => {
                    console.log('摄像头AR按钮被点击');
                    this.updateDebugInfo('启动摄像头AR模式...');
                    this.startCameraAR();
                });
                
                fallbackAR.addEventListener('click', () => {
                    console.log('测试模式按钮被点击');
                    this.updateDebugInfo('启动测试模式...');
                    this.startTestMode();
                });
                
                playButton.addEventListener('click', () => {
                    console.log('播放按钮被点击');
                    this.toggleAudio();
                });
                
                console.log('UI事件监听器已设置');
            }
            
            setupThreeJS() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x202020);
                
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 1.6, 3);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                
                // 检查WebXR支持
                if (this.renderer.xr) {
                    this.renderer.xr.enabled = true;
                    console.log('WebXR支持已启用');
                } else {
                    console.warn('当前THREE.js版本不支持WebXR');
                }
                
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(this.renderer.domElement);
                
                const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x444444);
                gridHelper.position.y = -1;
                this.scene.add(gridHelper);
                
                const testGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                const testMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x00ff00,
                    transparent: true,
                    opacity: 0.5
                });
                this.testCube = new THREE.Mesh(testGeometry, testMaterial);
                this.testCube.position.set(2, 0, -1);
                this.scene.add(this.testCube);
                
                this.renderer.setAnimationLoop(() => this.render());
                
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                console.log('Three.js设置完成');
            }
            
            async startWebXR() {
                if (!navigator.xr) {
                    alert('此设备不支持WebXR，请尝试测试模式');
                    return;
                }
                
                // 检查WebXR支持
                if (!this.renderer.xr) {
                    alert('当前THREE.js版本不支持WebXR，请尝试其他模式');
                    return;
                }
                
                try {
                    const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                    const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    
                    if (!vrSupported && !arSupported) {
                        alert('此设备不支持WebXR，请尝试测试模式');
                        return;
                    }
                    
                    const sessionMode = vrSupported ? 'immersive-vr' : 'immersive-ar';
                    this.xrSession = await navigator.xr.requestSession(sessionMode, {
                        requiredFeatures: ['local'],
                        optionalFeatures: ['bounded-floor', 'hand-tracking']
                    });
                    
                    await this.renderer.xr.setSession(this.xrSession);
                    this.referenceSpace = await this.xrSession.requestReferenceSpace('local');
                    
                    this.setupControllers();
                    this.isWebXRMode = true;
                    this.hideStartContainer();
                    this.showControls();
                    this.addTestButtons();
                    
                    this.updateStatus('WebXR运行中');
                    
                } catch (error) {
                    console.error('WebXR启动失败:', error);
                    alert('WebXR启动失败: ' + error.message);
                }
            }
            
            async startRealAR() {
                try {
                    console.log('启动传统AR模式（完整追踪）...');
                    this.updateDebugInfo('初始化AR.js组件...');
                    
                    // 注册用户原始的A-Frame组件
                    this.registerARComponents();
                    
                    // 预加载AR音频
                    await this.preloadARAssets();
                    
                    // 显示AR场景
                    document.getElementById('arScene').style.display = 'block';
                    document.getElementById('startContainer').style.display = 'none';
                    
                    // 设置AR控制按钮
                    this.setupARControls();
                    
                    this.isRealARMode = true;
                    this.updateDebugInfo('传统AR模式启动成功 - 使用pattern文件追踪');
                    
                    console.log('传统AR模式启动完成');
                    
                } catch (error) {
                    console.error('传统AR启动失败:', error);
                    this.updateDebugInfo('AR启动失败: ' + error.message);
                    alert('AR启动失败，请尝试其他模式');
                }
            }
            
            registerARComponents() {
                // 还原用户原始的动态旋转组件
                AFRAME.registerComponent('dynamic-rotation', {
                    schema: {
                        x: { type: 'number', default: 0 },
                        y: { type: 'number', default: 0 },
                        z: { type: 'number', default: 0 }
                    },
                    init: function () {
                        const el = this.el;
                        const data = this.data;
                        el.addEventListener('model-loaded', function () {
                            const mesh = el.getObject3D('mesh');
                            if (!mesh) return;
                            mesh.rotation.set(
                                THREE.Math.degToRad(data.x),
                                THREE.Math.degToRad(data.y),
                                THREE.Math.degToRad(data.z)
                            );
                        });
                    }
                });
                
                // 还原用户原始的AR标记追踪组件
                AFRAME.registerComponent('ar-marker-tracker', {
                    init: function () {
                        const el = this.el;
                        const markerId = el.getAttribute('id');
                        let currentAudio = null;
                        let audioPath = '';
                        let infoPath = '';
                        let infoText = '';
                        let isVisible = false;
                        
                        // 根据markerId设置音频和信息路径
                        if (markerId === 'marker1') {
                            audioPath = 'audio1.mp3';
                            infoPath = 'info1.txt';
                        } else if (markerId === 'marker2') {
                            audioPath = 'audio2.mp3';
                            infoPath = 'info2.txt';
                        }
                        
                        // 获取音频
                        if (window.app && window.app.arAudioCache.has(audioPath)) {
                            currentAudio = window.app.arAudioCache.get(audioPath);
                        }
                        
                        // 加载信息文本
                        fetch(infoPath)
                            .then(response => response.ok ? response.text() : '')
                            .then(text => {
                                infoText = text;
                            })
                            .catch(error => {
                                console.error('Error loading info text:', error);
                            });
                        
                        // 监听标记可见性变化
                        this.tick = AFRAME.utils.throttleTick(function () {
                            const newVisible = el.object3D.visible;
                            if (newVisible !== isVisible) {
                                isVisible = newVisible;
                                
                                if (isVisible) {
                                    // 标记出现
                                    console.log('标记出现:', markerId);
                                    
                                    // 切换当前音频
                                    if (window.app) {
                                        if (window.app.arCurrentAudio && window.app.arCurrentAudio !== currentAudio) {
                                            window.app.arCurrentAudio.pause();
                                            window.app.arIsPlaying = false;
                                        }
                                        
                                        window.app.arCurrentAudio = currentAudio;
                                        window.app.updateARInfo(infoText || '检测到乐器标记');
                                        window.app.enableARPlayButton();
                                    }
                                } else {
                                    // 标记消失
                                    console.log('标记消失:', markerId);
                                }
                            }
                        }, 100);
                    }
                });
                
                // 还原用户原始的动态材质组件
                AFRAME.registerComponent('dynamic-material', {
                    init: function () {
                        const el = this.el;
                        let colorIndex = 0;
                        const colors = ['#FF5733', '#33FF57', '#3357FF'];
                        
                        setInterval(function () {
                            colorIndex = (colorIndex + 1) % colors.length;
                            el.setAttribute('material', 'color', colors[colorIndex]);
                        }, 3000);
                    }
                });
                
                // 还原用户原始的动态光照组件
                AFRAME.registerComponent('dynamic-light', {
                    schema: {
                        intensity: { type: 'number', default: 1 }
                    },
                    init: function () {
                        const light = this.el.getOrCreateObject3D('light', THREE.PointLight);
                        light.intensity = this.data.intensity;
                        
                        // 动态调整光照强度
                        setInterval(() => {
                            light.intensity = 0.5 + Math.sin(Date.now() * 0.001) * 0.5;
                        }, 100);
                    },
                    update: function () {
                        const light = this.el.getObject3D('light');
                        if (light) {
                            light.intensity = this.data.intensity;
                        }
                    }
                });
                
                console.log('AR.js组件注册完成');
            }
            
            async preloadARAssets() {
                console.log('预加载AR音频资源...');
                const audioFiles = ['audio1.mp3', 'audio2.mp3'];
                
                for (const audioPath of audioFiles) {
                    try {
                        const audio = new Audio();
                        audio.src = audioPath;
                        audio.preload = 'auto';
                        
                        await new Promise((resolve) => {
                            audio.oncanplaythrough = resolve;
                            audio.onerror = resolve;
                            audio.load();
                        });
                        
                        this.arAudioCache.set(audioPath, audio);
                        console.log('AR音频预加载成功:', audioPath);
                        
                    } catch (error) {
                        console.error('AR音频预加载失败:', audioPath, error);
                    }
                }
            }
            
            setupARControls() {
                const arPlayButton = document.getElementById('arPlayButton');
                const stopARButton = document.getElementById('stopARButton');
                
                arPlayButton.addEventListener('click', () => {
                    this.toggleARAudio();
                });
                
                stopARButton.addEventListener('click', () => {
                    this.stopRealAR();
                });
            }
            
            toggleARAudio() {
                if (!this.arCurrentAudio) {
                    console.log('没有可播放的AR音频');
                    return;
                }
                
                if (this.arIsPlaying) {
                    this.arCurrentAudio.pause();
                    this.arIsPlaying = false;
                    document.getElementById('arPlayButton').textContent = '播放';
                } else {
                    this.arCurrentAudio.play().then(() => {
                        this.arIsPlaying = true;
                        document.getElementById('arPlayButton').textContent = '暂停';
                    }).catch((error) => {
                        console.error('AR音频播放失败:', error);
                    });
                }
            }
            
            enableARPlayButton() {
                const button = document.getElementById('arPlayButton');
                button.disabled = false;
                button.style.backgroundColor = '#007BFF';
                button.textContent = this.arIsPlaying ? '暂停' : '播放';
            }
            
            updateARInfo(text) {
                document.getElementById('arInfo').textContent = text;
            }
            
            stopRealAR() {
                // 停止AR模式
                document.getElementById('arScene').style.display = 'none';
                document.getElementById('startContainer').style.display = 'block';
                
                // 停止音频
                if (this.arCurrentAudio) {
                    this.arCurrentAudio.pause();
                    this.arCurrentAudio.currentTime = 0;
                    this.arIsPlaying = false;
                }
                
                this.isRealARMode = false;
                console.log('传统AR模式已停止');
            }
            
            startTestMode() {
                this.isWebXRMode = false;
                this.isCameraARMode = false;
                this.hideStartContainer();
                this.showControls();
                this.addTestButtons();
                this.setupMouseControls(); // 添加鼠标控制
                this.updateStatus('测试模式运行中 - 可拖动旋转模型');
            }
            
            async startCameraAR() {
                try {
                    console.log('启动摄像头AR模式...');
                    this.updateDebugInfo('请求摄像头权限...');
                    
                    // 请求摄像头权限
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'environment' // 后置摄像头
                        }
                    });
                    
                    // 设置视频流
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    video.style.display = 'block';
                    
                    // 显示扫描框
                    document.getElementById('cameraOverlay').style.display = 'block';
                    
                    this.isWebXRMode = false;
                    this.isCameraARMode = true;
                    this.hideStartContainer();
                    this.showControls();
                    
                    // 添加停止按钮
                    this.addStopCameraButton();
                    
                    // 开始二维码检测
                    await this.qrDetector.startCameraDetection((qrData) => {
                        this.handleQRDetection(qrData);
                    });
                    
                    this.updateStatus('摄像头AR运行中 - 扫描二维码');
                    this.updateDebugInfo('摄像头AR模式启动成功');
                    
                } catch (error) {
                    console.error('摄像头AR启动失败:', error);
                    this.updateDebugInfo('摄像头权限被拒绝或设备不支持');
                    alert('无法访问摄像头，请检查权限设置或尝试测试模式');
                }
            }
            
            addStopCameraButton() {
                const stopButton = document.createElement('button');
                stopButton.textContent = '停止摄像头';
                stopButton.style.cssText = `
                    position: absolute; top: 20px; right: 20px; padding: 10px 15px;
                    background: #dc3545; border: none; border-radius: 5px;
                    cursor: pointer; z-index: 10; color: white;
                `;
                stopButton.addEventListener('click', () => {
                    this.stopCameraAR();
                    stopButton.remove();
                });
                document.body.appendChild(stopButton);
            }
            
            stopCameraAR() {
                this.qrDetector.stopDetection();
                this.isCameraARMode = false;
                
                // 重新显示开始界面
                document.getElementById('startContainer').style.display = 'block';
                document.getElementById('info').style.display = 'none';
                document.getElementById('audioControls').style.display = 'none';
                document.getElementById('debugInfo').style.display = 'none';
                
                // 移除模型
                if (this.activeModel) {
                    this.scene.remove(this.activeModel);
                    this.activeModel = null;
                }
                
                console.log('摄像头AR已停止');
            }
            
            setupMouseControls() {
                // 添加鼠标控制功能
                this.mouseControls = {
                    isMouseDown: false,
                    previousMousePosition: { x: 0, y: 0 },
                    currentRotation: { x: 0, y: 0 }
                };
                
                const canvas = this.renderer.domElement;
                
                canvas.addEventListener('mousedown', (event) => {
                    this.mouseControls.isMouseDown = true;
                    this.mouseControls.previousMousePosition = {
                        x: event.clientX,
                        y: event.clientY
                    };
                    canvas.style.cursor = 'grabbing';
                });
                
                canvas.addEventListener('mousemove', (event) => {
                    if (!this.mouseControls.isMouseDown || !this.activeModel) return;
                    
                    const deltaMove = {
                        x: event.clientX - this.mouseControls.previousMousePosition.x,
                        y: event.clientY - this.mouseControls.previousMousePosition.y
                    };
                    
                    // 旋转模型
                    this.mouseControls.currentRotation.y += deltaMove.x * 0.01;
                    this.mouseControls.currentRotation.x += deltaMove.y * 0.01;
                    
                    this.activeModel.rotation.y = this.mouseControls.currentRotation.y;
                    this.activeModel.rotation.x = this.mouseControls.currentRotation.x;
                    
                    this.mouseControls.previousMousePosition = {
                        x: event.clientX,
                        y: event.clientY
                    };
                });
                
                canvas.addEventListener('mouseup', () => {
                    this.mouseControls.isMouseDown = false;
                    canvas.style.cursor = 'grab';
                });
                
                canvas.addEventListener('mouseleave', () => {
                    this.mouseControls.isMouseDown = false;
                    canvas.style.cursor = 'default';
                });
                
                // 鼠标滚轮缩放
                canvas.addEventListener('wheel', (event) => {
                    event.preventDefault();
                    if (!this.activeModel) return;
                    
                    const scaleFactor = event.deltaY > 0 ? 0.9 : 1.1;
                    this.activeModel.scale.multiplyScalar(scaleFactor);
                });
                
                canvas.style.cursor = 'grab';
                console.log('鼠标控制已启用：拖动旋转，滚轮缩放');
                this.updateDebugInfo('鼠标控制已启用');
            }
            
            addTestButtons() {
                const testButton1 = document.createElement('button');
                testButton1.textContent = '测试乐器1';
                testButton1.style.cssText = `
                    position: absolute; top: 120px; left: 20px; padding: 10px 15px;
                    background: #FFC107; border: none; border-radius: 5px;
                    cursor: pointer; z-index: 10; color: black;
                `;
                testButton1.addEventListener('click', () => this.handleQRDetection('pattern1'));
                document.body.appendChild(testButton1);
                
                const testButton2 = document.createElement('button');
                testButton2.textContent = '测试乐器2';
                testButton2.style.cssText = `
                    position: absolute; top: 160px; left: 20px; padding: 10px 15px;
                    background: #17a2b8; border: none; border-radius: 5px;
                    cursor: pointer; z-index: 10; color: white;
                `;
                testButton2.addEventListener('click', () => this.handleQRDetection('pattern2'));
                document.body.appendChild(testButton2);
            }
            
            setupControllers() {
                for (let i = 0; i < 2; i++) {
                    const controller = this.renderer.xr.getController(i);
                    controller.addEventListener('select', (event) => this.onControllerSelect(event));
                    this.scene.add(controller);
                    this.controllers.push(controller);
                    
                    const geometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, 0, 0),
                        new THREE.Vector3(0, 0, -1)
                    ]);
                    const line = new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
                    controller.add(line);
                }
            }
            
            onControllerSelect(event) {
                if (this.activeModel) {
                    this.activeModel.rotation.y += Math.PI / 4;
                    console.log('模型已旋转');
                }
            }
            
            async handleQRDetection(qrData) {
                console.log('处理二维码:', qrData);
                
                const config = this.instrumentConfigs[qrData];
                if (!config) {
                    this.updateQRResult('未知二维码: ' + qrData);
                    return;
                }
                
                this.updateQRResult(qrData);
                this.updateCurrentInstrument(config.name);
                await this.switchInstrument(qrData, config);
            }
            
            async switchInstrument(instrumentId, config) {
                try {
                    if (this.activeModel) {
                        this.scene.remove(this.activeModel);
                        this.activeModel = null;
                    }
                    
                    const model = await this.loadModel(config.model);
                    if (model) {
                        // 根据模式调整位置
                        if (this.isWebXRMode) {
                            model.position.set(0, 0, -2); // WebXR模式：在用户前方
                        } else if (this.isCameraARMode) {
                            model.position.set(0, 0, -1); // 摄像头AR模式：稍近一些
                        } else {
                            model.position.set(0, 0, 0);  // 测试模式：中央
                        }
                        
                        model.scale.set(...config.scale);
                        this.scene.add(model);
                        this.activeModel = model;
                        
                        // 重置鼠标控制旋转
                        if (this.mouseControls) {
                            this.mouseControls.currentRotation = { x: 0, y: 0 };
                        }
                        
                        this.addDynamicMaterial(model);
                        await this.audioManager.switchAudio(config.audio);
                        this.updateAudioInfo(config.name);
                        this.enableAudioButton();
                        
                        console.log('乐器加载成功:', config.name);
                        this.updateDebugInfo(`${config.name} 已加载到场景`);
                    }
                    
                } catch (error) {
                    console.error('切换乐器失败:', error);
                    this.updateStatus('模型加载失败: ' + error.message);
                }
            }
            
            async loadModel(modelPath) {
                if (this.loadedModels.has(modelPath)) {
                    return this.loadedModels.get(modelPath).clone();
                }
                
                if (!this.modelLoader) {
                    throw new Error('GLTFLoader尚未初始化');
                }
                
                return new Promise((resolve, reject) => {
                    this.modelLoader.load(
                        modelPath,
                        (gltf) => {
                            gltf.scene.traverse((child) => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                }
                            });
                            
                            this.loadedModels.set(modelPath, gltf.scene);
                            resolve(gltf.scene.clone());
                        },
                        (progress) => {
                            if (progress.total > 0) {
                                const percent = (progress.loaded / progress.total * 100).toFixed(1);
                                console.log('加载进度:', percent + '%');
                            }
                        },
                        (error) => {
                            console.error('GLTF加载失败:', error);
                            const fallbackModel = this.createFallbackModel(modelPath);
                            resolve(fallbackModel);
                        }
                    );
                });
            }
            
            createFallbackModel(modelPath) {
                const group = new THREE.Group();
                
                if (modelPath.includes('model1')) {
                    const geometry = new THREE.BoxGeometry(1, 0.3, 2);
                    const material = new THREE.MeshPhongMaterial({ color: 0x8B4513 });
                    const piano = new THREE.Mesh(geometry, material);
                    group.add(piano);
                    
                    for (let i = 0; i < 7; i++) {
                        const keyGeometry = new THREE.BoxGeometry(0.1, 0.05, 0.3);
                        const keyMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                        const key = new THREE.Mesh(keyGeometry, keyMaterial);
                        key.position.set(-0.35 + i * 0.12, 0.2, 0.8);
                        group.add(key);
                    }
                } else {
                    const geometry = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 16);
                    const material = new THREE.MeshPhongMaterial({ color: 0x696969 });
                    const drum = new THREE.Mesh(geometry, material);
                    group.add(drum);
                    
                    const topGeometry = new THREE.CircleGeometry(0.8, 16);
                    const topMaterial = new THREE.MeshPhongMaterial({ color: 0xF5DEB3 });
                    const drumTop = new THREE.Mesh(topGeometry, topMaterial);
                    drumTop.rotation.x = -Math.PI / 2;
                    drumTop.position.y = 0.25;
                    group.add(drumTop);
                }
                
                return group;
            }
            
            addDynamicMaterial(model) {
                const colors = [0xFF5733, 0x33FF57, 0x3357FF, 0xFFFF33, 0xFF33FF];
                let colorIndex = 0;
                
                const interval = setInterval(() => {
                    if (!model.parent) {
                        clearInterval(interval);
                        return;
                    }
                    
                    model.traverse((child) => {
                        if (child.isMesh && child.material && child.material.color) {
                            colorIndex = (colorIndex + 1) % colors.length;
                            child.material.color.setHex(colors[colorIndex]);
                        }
                    });
                }, 3000);
            }
            
            toggleAudio() {
                this.audioManager.togglePlayback();
            }
            
            render() {
                if (this.testCube) {
                    this.testCube.rotation.x += 0.01;
                    this.testCube.rotation.y += 0.01;
                }
                
                // 只在非摄像头AR模式和非鼠标控制模式下自动旋转
                if (this.activeModel && !this.isCameraARMode && !this.mouseControls) {
                    this.activeModel.rotation.y += 0.005;
                }
                
                this.renderer.render(this.scene, this.camera);
            }
            
            hideStartContainer() {
                document.getElementById('startContainer').style.display = 'none';
            }
            
            showControls() {
                document.getElementById('info').style.display = 'block';
                document.getElementById('audioControls').style.display = 'block';
                document.getElementById('debugInfo').style.display = 'block';
            }
            
            updateStatus(status) {
                document.getElementById('status').textContent = status;
            }
            
            updateQRResult(result) {
                document.getElementById('qrResult').textContent = result;
            }
            
            updateCurrentInstrument(instrument) {
                document.getElementById('currentInstrument').textContent = instrument;
            }
            
            updateAudioInfo(info) {
                document.getElementById('audioInfo').textContent = info;
            }
            
            updateDebugInfo(info) {
                const debugText = document.getElementById('debugText');
                if (debugText) {
                    debugText.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + info + '</div>';
                    debugText.scrollTop = debugText.scrollHeight;
                }
            }
            
            enableAudioButton() {
                const button = document.getElementById('playButton');
                button.disabled = false;
                button.style.backgroundColor = '#007BFF';
            }
        }
        
        // 音频管理器
        class AudioManager {
            constructor() {
                this.audioCache = new Map();
                this.currentAudio = null;
                this.isPlaying = false;
            }
            
            async preloadAudio(configs) {
                for (const [key, config] of Object.entries(configs)) {
                    try {
                        const audio = new Audio();
                        audio.src = config.audio;
                        audio.preload = 'auto';
                        
                        await new Promise((resolve) => {
                            audio.oncanplaythrough = resolve;
                            audio.onerror = resolve;
                            audio.load();
                        });
                        
                        this.audioCache.set(config.audio, audio);
                    } catch (error) {
                        console.error('音频处理错误:', error);
                    }
                }
            }
            
            async switchAudio(audioPath) {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                
                this.currentAudio = this.audioCache.get(audioPath);
                this.isPlaying = false;
                this.updatePlayButton();
            }
            
            togglePlayback() {
                if (!this.currentAudio) return;
                
                if (this.isPlaying) {
                    this.currentAudio.pause();
                    this.isPlaying = false;
                } else {
                    this.currentAudio.play().then(() => {
                        this.isPlaying = true;
                    }).catch((error) => {
                        console.error('音频播放失败:', error);
                    });
                }
                this.updatePlayButton();
            }
            
            updatePlayButton() {
                const button = document.getElementById('playButton');
                if (button) {
                    button.textContent = this.isPlaying ? '暂停' : '播放';
                }
            }
        }
        
        // 二维码检测器
        class QRDetector {
            constructor() {
                this.canvas = null;
                this.context = null;
                this.video = null;
                this.isDetecting = false;
                this.onDetectionCallback = null;
                this.detectionInterval = null;
            }
            
            init() {
                this.canvas = document.getElementById('qrCanvas');
                this.context = this.canvas.getContext('2d');
                this.canvas.width = 640;
                this.canvas.height = 480;
            }
            
            async startCameraDetection(callback) {
                this.onDetectionCallback = callback;
                this.video = document.getElementById('cameraVideo');
                this.isDetecting = true;
                
                // 等待视频准备就绪
                await new Promise((resolve) => {
                    if (this.video.readyState >= 2) {
                        resolve();
                    } else {
                        this.video.addEventListener('loadeddata', resolve, { once: true });
                    }
                });
                
                console.log('开始二维码检测...');
                this.detectLoop();
            }
            
            detectLoop() {
                if (!this.isDetecting || !this.video) return;
                
                try {
                    // 调整canvas大小匹配视频
                    if (this.video.videoWidth > 0) {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                    }
                    
                    // 将视频帧绘制到canvas
                    this.context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // 获取图像数据
                    const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // 检测二维码
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code && this.onDetectionCallback) {
                        console.log('检测到二维码:', code.data);
                        this.onDetectionCallback(code.data);
                        
                        // 短暂停止检测，避免重复触发
                        this.isDetecting = false;
                        setTimeout(() => {
                            this.isDetecting = true;
                        }, 2000);
                    }
                } catch (error) {
                    console.error('二维码检测错误:', error);
                }
                
                // 继续检测
                if (this.isDetecting) {
                    requestAnimationFrame(() => this.detectLoop());
                }
            }
            
            stopDetection() {
                this.isDetecting = false;
                if (this.video && this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                    this.video.style.display = 'none';
                }
                document.getElementById('cameraOverlay').style.display = 'none';
                console.log('二维码检测已停止');
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化...');
            console.log('THREE版本:', THREE.REVISION);
            console.log('jsQR可用:', typeof jsQR !== 'undefined');
            console.log('WebXR可用:', !!navigator.xr);
            console.log('GLTFLoader可用:', typeof THREE.GLTFLoader !== 'undefined');
            console.log('DRACOLoader可用:', typeof THREE.DRACOLoader !== 'undefined');
            console.log('A-Frame可用:', typeof AFRAME !== 'undefined');
            console.log('WebXR renderer support:', !!THREE.WebGLRenderer && !!THREE.WebGLRenderer.prototype.xr);
            
            // 检查和修复jsQR
            if (typeof jsQR === 'undefined') {
                console.warn('jsQR未加载，摄像头AR功能可能不可用');
            }
            
            // 修复WebXR支持
            if (window.THREE_R128 && window.THREE_R128.WebXRManager && !THREE.WebGLRenderer.prototype.xr) {
                console.log('恢复WebXR支持...');
                Object.defineProperty(THREE.WebGLRenderer.prototype, 'xr', {
                    get: function() {
                        if (!this._xr) {
                            this._xr = { enabled: false };
                        }
                        return this._xr;
                    },
                    set: function(value) {
                        this._xr = value;
                    }
                });
            }
            
            try {
                app = new WebXRARInstrument();
                window.app = app; // 设置全局引用供A-Frame组件使用
                console.log('应用初始化成功');
            } catch (error) {
                console.error('应用初始化失败:', error);
                document.getElementById('startContainer').innerHTML = 
                    '<h2>初始化失败</h2><p>错误: ' + error.message + '</p>' +
                    '<button onclick="location.reload()">重新加载</button>' +
                    '<br><br><button onclick="showDownloadLinks()">查看下载说明</button>' +
                    '<br><br><div style="text-align:left;font-size:12px;margin-top:10px;">' +
                    '<strong>调试信息:</strong><br>' +
                    'THREE版本: ' + THREE.REVISION + '<br>' +
                    'jsQR: ' + (typeof jsQR !== 'undefined' ? '可用' : '不可用') + '<br>' +
                    'A-Frame: ' + (typeof AFRAME !== 'undefined' ? '可用' : '不可用') + '<br>' +
                    'WebXR: ' + (!!navigator.xr ? '支持' : '不支持') + '<br>' +
                    '</div>';
            }
        });
        
        // 错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全局错误捕获:", {
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error
            });
        };
    </script>
</body>
</html>