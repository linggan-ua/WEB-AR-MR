<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>岭南乐器WebXR增强现实视听工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #startContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }
        
        #startWebXR {
            padding: 20px 40px;
            font-size: 18px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }
        
        #fallbackAR {
            padding: 15px 30px;
            font-size: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10;
        }
        
        #audioControls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
        }
        
        #playButton {
            padding: 10px 20px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        #playButton:disabled {
            background: grey;
            cursor: not-allowed;
        }
        
        #qrCanvas {
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="startContainer">
        <h2>岭南乐器WebXR体验</h2>
        <p>请选择体验模式：</p>
        <button id="startWebXR">启动WebXR模式</button>
        <br>
        <button id="fallbackAR">传统AR模式</button>
        <p><small>WebXR模式需要VR头显支持</small></p>
    </div>
    
    <div id="info" class="hidden">
        <div>状态: <span id="status">准备就绪</span></div>
        <div>检测到的码: <span id="qrResult">无</span></div>
        <div>当前乐器: <span id="currentInstrument">无</span></div>
        <div id="instructionText">请将二维码置于视野中心</div>
    </div>
    
    <div id="audioControls" class="hidden">
        <button id="playButton" disabled>播放</button>
        <span id="audioInfo">无音频</span>
    </div>
    
    <canvas id="qrCanvas"></canvas>

    <script>
        class WebXRARInstrument {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.xrSession = null;
                this.referenceSpace = null;
                this.controllers = [];
                this.currentInstrument = null;
                this.audioManager = new AudioManager();
                this.qrDetector = new QRDetector();
                this.modelLoader = new THREE.GLTFLoader();
                this.isWebXRMode = false;
                
                // 乐器配置 - 对应原项目的marker1和marker2
                this.instrumentConfigs = {
                    'pattern1': {
                        model: 'model1.gltf',
                        audio: 'audio1.mp3',
                        info: 'info1.txt',
                        scale: [0.02, 0.02, 0.02],
                        name: '乐器1'
                    },
                    'pattern2': {
                        model: 'model2.gltf', 
                        audio: 'audio2.mp3',
                        info: 'info2.txt',
                        scale: [0.03, 0.03, 0.03],
                        name: '乐器2'
                    }
                };
                
                this.loadedModels = new Map();
                this.activeModel = null;
                
                this.init();
            }
            
            async init() {
                this.setupUI();
                this.setupThreeJS();
                await this.audioManager.preloadAudio(this.instrumentConfigs);
                this.qrDetector.init();
            }
            
            setupUI() {
                const startWebXR = document.getElementById('startWebXR');
                const fallbackAR = document.getElementById('fallbackAR');
                const playButton = document.getElementById('playButton');
                
                startWebXR.addEventListener('click', () => this.startWebXR());
                fallbackAR.addEventListener('click', () => this.startFallbackMode());
                playButton.addEventListener('click', () => this.toggleAudio());
            }
            
            setupThreeJS() {
                // 创建场景
                this.scene = new THREE.Scene();
                
                // 创建相机
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 1.6, 0); // VR标准高度
                
                // 创建渲染器
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                this.renderer.setClearColor(0x000000, 0);
                document.body.appendChild(this.renderer.domElement);
                
                // 添加灯光
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                this.scene.add(directionalLight);
                
                // 动态光照（保持原项目特性）
                this.addDynamicLighting();
                
                // 设置渲染循环
                this.renderer.setAnimationLoop(() => this.render());
            }
            
            addDynamicLighting() {
                const pointLight = new THREE.PointLight(0xffffff, 1, 100);
                pointLight.position.set(0, 2, 0);
                this.scene.add(pointLight);
                
                // 动态调整光照强度
                setInterval(() => {
                    pointLight.intensity = 0.5 + Math.sin(Date.now() * 0.001) * 0.5;
                }, 100);
            }
            
            async startWebXR() {
                if (!navigator.xr) {
                    alert('此设备不支持WebXR');
                    return;
                }
                
                try {
                    // 检查VR支持
                    const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                    if (!vrSupported) {
                        alert('此设备不支持WebXR VR模式');
                        return;
                    }
                    
                    this.updateStatus('启动WebXR...');
                    
                    // 请求摄像头权限
                    await this.requestCameraAccess();
                    
                    // 启动WebXR会话
                    this.xrSession = await navigator.xr.requestSession('immersive-vr', {
                        requiredFeatures: ['local'],
                        optionalFeatures: ['bounded-floor', 'hand-tracking']
                    });
                    
                    await this.renderer.xr.setSession(this.xrSession);
                    this.referenceSpace = await this.xrSession.requestReferenceSpace('local');
                    
                    // 设置控制器
                    this.setupControllers();
                    
                    // 开始二维码检测
                    this.startQRDetection();
                    
                    this.isWebXRMode = true;
                    this.hideStartContainer();
                    this.showControls();
                    this.updateStatus('WebXR运行中 - 寻找二维码...');
                    
                } catch (error) {
                    console.error('WebXR启动失败:', error);
                    this.updateStatus('启动失败: ' + error.message);
                    alert('WebXR启动失败，请尝试传统AR模式');
                }
            }
            
            async requestCameraAccess() {
                try {
                    this.cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'environment'
                        }
                    });
                    console.log('摄像头访问成功');
                } catch (error) {
                    console.error('摄像头访问失败:', error);
                    throw new Error('无法访问摄像头，请检查权限设置');
                }
            }
            
            setupControllers() {
                // 设置手柄控制器
                for (let i = 0; i < 2; i++) {
                    const controller = this.renderer.xr.getController(i);
                    controller.addEventListener('select', (event) => this.onControllerSelect(event));
                    controller.addEventListener('selectstart', (event) => this.onControllerSelectStart(event));
                    controller.addEventListener('selectend', (event) => this.onControllerSelectEnd(event));
                    this.scene.add(controller);
                    this.controllers.push(controller);
                    
                    // 添加控制器射线
                    const geometry = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, 0, 0),
                        new THREE.Vector3(0, 0, -1)
                    ]);
                    const line = new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
                    controller.add(line);
                }
            }
            
            onControllerSelect(event) {
                if (this.activeModel) {
                    // 手柄点击时旋转模型
                    this.activeModel.rotation.y += Math.PI / 4;
                    console.log('模型已旋转');
                }
            }
            
            onControllerSelectStart(event) {
                // 手柄按下时的反馈
                if (this.activeModel) {
                    this.activeModel.scale.multiplyScalar(1.1);
                }
            }
            
            onControllerSelectEnd(event) {
                // 手柄松开时的反馈
                if (this.activeModel) {
                    this.activeModel.scale.multiplyScalar(1/1.1);
                }
            }
            
            startQRDetection() {
                this.qrDetector.startDetection((qrData) => {
                    this.handleQRDetection(qrData);
                });
            }
            
            async handleQRDetection(qrData) {
                console.log('检测到二维码:', qrData);
                
                // 检查是否是已配置的乐器码
                const config = this.instrumentConfigs[qrData];
                if (!config) {
                    this.updateQRResult('未知二维码: ' + qrData);
                    return;
                }
                
                this.updateQRResult(qrData);
                this.updateCurrentInstrument(config.name);
                
                // 切换乐器
                await this.switchInstrument(qrData, config);
            }
            
            async switchInstrument(instrumentId, config) {
                try {
                    // 移除当前模型
                    if (this.activeModel) {
                        this.scene.remove(this.activeModel);
                    }
                    
                    // 加载新模型
                    const model = await this.loadModel(config.model);
                    if (model) {
                        // 设置模型位置和缩放
                        model.position.set(0, 0, -2); // 在用户前方2米
                        model.scale.set(...config.scale);
                        
                        // 添加动态材质变化（保持原项目特性）
                        this.addDynamicMaterial(model);
                        
                        this.scene.add(model);
                        this.activeModel = model;
                        
                        // 切换音频
                        await this.audioManager.switchAudio(config.audio);
                        this.updateAudioInfo(config.name);
                        this.enableAudioButton();
                        
                        console.log(`乐器${config.name}加载成功`);
                    }
                    
                } catch (error) {
                    console.error('切换乐器失败:', error);
                    this.updateStatus('模型加载失败');
                }
            }
            
            async loadModel(modelPath) {
                if (this.loadedModels.has(modelPath)) {
                    return this.loadedModels.get(modelPath).clone();
                }
                
                return new Promise((resolve, reject) => {
                    this.modelLoader.load(
                        modelPath,
                        (gltf) => {
                            this.loadedModels.set(modelPath, gltf.scene);
                            resolve(gltf.scene.clone());
                        },
                        (progress) => {
                            console.log('加载进度:', (progress.loaded / progress.total * 100) + '%');
                        },
                        (error) => {
                            console.error('模型加载错误:', error);
                            reject(error);
                        }
                    );
                });
            }
            
            addDynamicMaterial(model) {
                const colors = [0xFF5733, 0x33FF57, 0x3357FF];
                let colorIndex = 0;
                
                setInterval(() => {
                    model.traverse((child) => {
                        if (child.isMesh && child.material) {
                            colorIndex = (colorIndex + 1) % colors.length;
                            child.material.color.setHex(colors[colorIndex]);
                        }
                    });
                }, 10000);
            }
            
            startFallbackMode() {
                // 跳转到原始AR页面
                window.location.href = '/';
            }
            
            toggleAudio() {
                this.audioManager.togglePlayback();
            }
            
            render() {
                if (this.isWebXRMode && this.xrSession) {
                    // WebXR渲染
                    this.renderer.render(this.scene, this.camera);
                } else {
                    // 普通渲染
                    this.renderer.render(this.scene, this.camera);
                }
            }
            
            // UI辅助方法
            hideStartContainer() {
                document.getElementById('startContainer').classList.add('hidden');
            }
            
            showControls() {
                document.getElementById('info').classList.remove('hidden');
                document.getElementById('audioControls').classList.remove('hidden');
            }
            
            updateStatus(status) {
                document.getElementById('status').textContent = status;
            }
            
            updateQRResult(result) {
                document.getElementById('qrResult').textContent = result;
            }
            
            updateCurrentInstrument(instrument) {
                document.getElementById('currentInstrument').textContent = instrument;
            }
            
            updateAudioInfo(info) {
                document.getElementById('audioInfo').textContent = info;
            }
            
            enableAudioButton() {
                const button = document.getElementById('playButton');
                button.disabled = false;
                button.style.backgroundColor = '#007BFF';
            }
        }
        
        // 音频管理器
        class AudioManager {
            constructor() {
                this.audioCache = new Map();
                this.currentAudio = null;
                this.isPlaying = false;
            }
            
            async preloadAudio(configs) {
                for (const [key, config] of Object.entries(configs)) {
                    try {
                        const audio = new Audio();
                        audio.src = config.audio;
                        audio.preload = 'auto';
                        await new Promise((resolve, reject) => {
                            audio.oncanplaythrough = resolve;
                            audio.onerror = reject;
                            audio.load();
                        });
                        this.audioCache.set(config.audio, audio);
                        console.log(`音频预加载成功: ${config.audio}`);
                    } catch (error) {
                        console.error(`音频预加载失败: ${config.audio}`, error);
                    }
                }
            }
            
            async switchAudio(audioPath) {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                
                this.currentAudio = this.audioCache.get(audioPath);
                this.isPlaying = false;
                this.updatePlayButton();
            }
            
            togglePlayback() {
                if (!this.currentAudio) return;
                
                if (this.isPlaying) {
                    this.currentAudio.pause();
                    this.isPlaying = false;
                } else {
                    this.currentAudio.play();
                    this.isPlaying = true;
                }
                this.updatePlayButton();
            }
            
            updatePlayButton() {
                const button = document.getElementById('playButton');
                button.textContent = this.isPlaying ? '暂停' : '播放';
            }
        }
        
        // 二维码检测器
        class QRDetector {
            constructor() {
                this.canvas = null;
                this.context = null;
                this.video = null;
                this.isDetecting = false;
                this.onDetectionCallback = null;
            }
            
            init() {
                this.canvas = document.getElementById('qrCanvas');
                this.context = this.canvas.getContext('2d');
                this.canvas.width = 640;
                this.canvas.height = 480;
            }
            
            async startDetection(callback) {
                this.onDetectionCallback = callback;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    
                    this.video = document.createElement('video');
                    this.video.srcObject = stream;
                    this.video.play();
                    
                    this.isDetecting = true;
                    this.detectLoop();
                    
                } catch (error) {
                    console.error('启动二维码检测失败:', error);
                }
            }
            
            detectLoop() {
                if (!this.isDetecting) return;
                
                if (this.video && this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                    this.context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code && this.onDetectionCallback) {
                        this.onDetectionCallback(code.data);
                    }
                }
                
                requestAnimationFrame(() => this.detectLoop());
            }
            
            stopDetection() {
                this.isDetecting = false;
                if (this.video && this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                }
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            new WebXRARInstrument();
        });
        
        // 错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("错误捕获:", {
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error
            });
        };
    </script>
</body>
</html>